AArch64 MP+dmb.st+acq-gcsb-gcspop
variant=shadowstack,vmsa
{
uint64_t z=0;

SS(x,1);

[PTE(z)]=(oa:PA(x)); (* Alias z to x, otherwise STR would fault *)

0:X2=y;
0:X4=z;

1:X2=y;
1:GCSPR_EL1=x;
}

P0            | P1;
MOV X0,#4     | LDAR W1,[X2] (* Memory Read effect (with Acquire) *);
STR X0,[X4]   | GCSB DSYNC   (* GCSB effect                       *);
DMB ST        | GCSPOPM X3   (* GCS (Read) effect                 *);
MOV W1,#1     |                                                     ;
STR W1,[X2]   |                                                     ;

exists 1:X1=1 /\ 1:X3=0